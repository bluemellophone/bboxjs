(function(){var e;function t(e,t){var s,i,o,n,r,l,a,h,d,c;for(s=e.x,i=e.y,o=t.x,n=t.y,r=Math.min(s,o),l=Math.max(s,o),a=Math.min(i,n),h=l-r,d=Math.max(i,n)-a,s<o&&i<n?c=Math.atan2(d,h):s<o&&i>=n?(c=Math.atan2(d,h),c*=-1):s>=o&&i<n?(c=Math.atan2(h,d),c+=.5*Math.PI):s>=o&&i>=n&&(c=Math.atan2(d,h),c+=Math.PI);c<0;)c+=2*Math.PI;for(;c>2*Math.PI;)c-=2*Math.PI;return c}$.fn.swapWith=function(e){var t=this,s=$(e),i=$("<div>");return t.before(i),s.before(t),i.after(s).remove(),t},e=function(){function e(e,t){void 0!==t||(t={}),void 0!==t.prefix||(t.prefix=""),void 0!==t.ids||(t.ids={}),void 0!==t.ids.rectangle||(t.ids.rectangle=t.prefix+"bbox-selector-rectangle"),void 0!==t.ids.diagonal||(t.ids.diagonal=t.prefix+"bbox-selector-diagonal"),void 0!==t.colors||(t.colors={}),void 0!==t.colors.subentry||(t.colors.subentry="#444444"),void 0!==t.border||(t.border={}),void 0!==t.border.color||(t.border.color="#7FFF7F"),void 0!==t.border.width||(t.border.width=2),void 0!==t.limits.bounds||(t.limits.bounds={}),void 0!==t.limits.bounds.x||(t.limits.bounds.x={}),void 0!==t.limits.bounds.x.min||(t.limits.bounds.x.min=0),void 0!==t.limits.bounds.x.max||(t.limits.bounds.x.max=0),void 0!==t.limits.bounds.y||(t.limits.bounds.y={}),void 0!==t.limits.bounds.y.min||(t.limits.bounds.y.min=0),void 0!==t.limits.bounds.y.max||(t.limits.bounds.y.max=0),void 0!==t.modes||(t.modes=["rectangle","diagonal","diagonal2"]),void 0!==t.mode||(t.mode="rectangle"),void 0!==t.debug||(t.debug=!1),this.options=t,this.points={},this.elements={},this.current_stage=0,this.debug=[],this.create_selector_elements(e),this.update_mode(this.options.mode)}return e.prototype.create_selector_elements=function(e){var t,s;if(this.elements.frame=e,t={border:this.options.border.width+"px dotted "+this.options.border.color,position:"absolute","transform-origin":"0% 0%"},this.elements.rectangle=$('<div id="'+this.options.ids.rectangle+'"></div>'),this.elements.rectangle.css(t),this.elements.frame.append(this.elements.rectangle),this.elements.rectangle.hide(),this.elements.diagonal=$('<div id="'+this.options.ids.diagonal+'"></div>'),this.elements.diagonal.css(t),this.elements.frame.append(this.elements.diagonal),this.elements.diagonal.hide(),this.options.debug){s={top:"0.0",left:"0.0",width:"10px",height:"10px",position:"absolute","border-radius":"10px",border:"1px solid #fff","margin-top":"-6px","margin-left":"-6px"},colors=["red","green","blue"];for(var i=0;i<colors.length;i++)this.debug.push($("<div></div>")),this.debug[i].css(s),this.debug[i].css({"background-color":colors[i]}),this.elements.frame.append(this.debug)}},e.prototype.update_mode=function(e){switch(e){case"rectangle":case"diagonal":case"diagonal2":-1==this.options.modes.indexOf(e)?console.log("[BBoxSelector] User disabled selection mode provided: "+e):this.options.mode=e;break;default:console.log("[BBoxSelector] Invalid selection mode provided: "+e)}return this.options.mode},e.prototype.check_boundaries=function(e){var t,s,i;return t=this.elements.frame.offset(),s={x:e.pageX-t.left,y:e.pageY-t.top},i="rectangle"==this.options.mode?{x:{min:0,max:0},y:{min:0,max:0}}:this.options.limits.bounds,s.x=Math.max(s.x,0-i.x.min),s.y=Math.max(s.y,0-i.y.min),s.x=Math.min(s.x,this.elements.frame.width()-1+i.x.max),s.y=Math.min(s.y,this.elements.frame.height()-1+i.y.max),s},e.prototype.start=function(e,t){var s;void 0!==t||(t=!1),this.points.origin=this.check_boundaries(e),this.points.middle={x:NaN,y:NaN},this.points.cursor=this.points.origin,this.current_stage=0,"rectangle"==this.options.mode?(this.elements.rectangle.show(),this.elements.diagonal.hide(),this.elements.rectangle.css({opacity:"0.0"})):(this.elements.rectangle.hide(),this.elements.diagonal.show(),this.elements.diagonal.css({opacity:"0.0",width:"0px"})),s=t?{outline:this.options.border.width+"px solid "+this.options.colors.subentry}:{outline:"none"},this.elements.rectangle.css(s),this.elements.diagonal.css(s),$("body").css({cursor:"crosshair"}),document.onselectstart=function(){return!1}},e.prototype.stage=function(e){var t;return t=!1,"rectangle"==this.options.mode?t=!0:0==this.current_stage?(this.current_stage=1,this.elements.rectangle.show()):t=!0,this.refresh(e),t},e.prototype.finish=function(e){var t;return t=null==e?null:this.get_selector_data(e),this.elements.rectangle.hide(),this.elements.diagonal.hide(),$("body").css({cursor:"default"}),document.onselectstart=null,t},e.prototype.update_cursor=function(e){this.points.cursor=this.check_boundaries(e),1!=this.current_stage&&(this.points.middle=this.points.cursor),this.refresh(e)},e.prototype.get_selector_data=function(e){var s,i,o,n,r,l,a;((o={pixels:{origin:this.points.origin,middle:this.points.middle,cursor:this.points.cursor},percent:{},angles:{},metadata:{}}).pixels.xtl=Math.min(o.pixels.origin.x,o.pixels.middle.x),o.pixels.ytl=Math.min(o.pixels.origin.y,o.pixels.middle.y),o.pixels.xbr=Math.max(o.pixels.origin.x,o.pixels.middle.x),o.pixels.ybr=Math.max(o.pixels.origin.y,o.pixels.middle.y),o.pixels.width=o.pixels.xbr-o.pixels.xtl,o.pixels.height=o.pixels.ybr-o.pixels.ytl,o.pixels.hypo=Math.sqrt(Math.pow(o.pixels.width,2)+Math.pow(o.pixels.height,2)),n=o.pixels.middle.x-o.pixels.cursor.x,r=o.pixels.middle.y-o.pixels.cursor.y,o.pixels.right=Math.sqrt(Math.pow(n,2)+Math.pow(r,2)),o.angles.origin=t(o.pixels.origin,o.pixels.middle),o.angles.middle=t(o.pixels.middle,o.pixels.cursor),o.angles.right=o.angles.origin-.5*Math.PI,o.angles.theta=o.angles.origin,"rectangle"==this.options.mode)?(o.pixels.left=o.pixels.xtl,o.pixels.top=o.pixels.ytl,o.angles.theta=0):(this.current_stage>0&&(l=o.angles.middle-o.angles.origin,a=Math.sin(l)*o.pixels.right,o.pixels.adjacent=Math.abs(a),o.pixels.correction={x:Math.cos(o.angles.right)*o.pixels.adjacent,y:Math.sin(o.angles.right)*o.pixels.adjacent},o.angles.fixed=a>0,o.angles.fixed&&(o.angles.theta+=Math.PI)),centers={},centers.hypo={x:o.pixels.xtl+.5*o.pixels.width,y:o.pixels.ytl+.5*o.pixels.height},centers.rect={x:o.pixels.xtl+.5*this.elements.rectangle.width(),y:o.pixels.ytl+.5*this.elements.rectangle.height()},centers.offset={x:centers.hypo.x-centers.rect.x,y:centers.hypo.y-centers.rect.y},this.debug.length>0&&(this.debug[0].css({top:o.pixels.ytl+"px",left:o.pixels.xtl+"px"}),this.debug[1].css({top:centers.hypo.y+"px",left:centers.hypo.x+"px"}),this.debug[2].css({top:centers.rect.y+"px",left:centers.rect.x+"px"})),o.pixels.left=o.pixels.xtl+centers.offset.x,o.pixels.top=o.pixels.ytl+centers.offset.y,o.pixels.width=this.elements.rectangle.width(),o.pixels.height=this.elements.rectangle.height());for(s=this.elements.frame.width(),i=this.elements.frame.height(),o.percent.left=100*o.pixels.left/s,o.percent.top=100*o.pixels.top/i,o.percent.width=100*o.pixels.width/s,o.percent.height=100*o.pixels.height/i;o.angles.theta<0;)o.angles.theta+=2*Math.PI;for(;o.angles.theta>2*Math.PI;)o.angles.theta-=2*Math.PI;return o},e.prototype.refresh=function(e){var t,s,i;t=this.get_selector_data(e),"rectangle"==this.options.mode?(s=t.angles.theta,this.elements.rectangle.css({top:t.percent.top+"%",left:t.percent.left+"%",width:t.percent.width+"%",height:t.percent.height+"%",opacity:"1.0"})):(s=t.angles.origin,0==this.current_stage?(this.elements.diagonal.css({top:t.pixels.origin.y+"px",left:t.pixels.origin.x+"px",width:t.pixels.hypo+"px",opacity:"1.0"}),this.elements.rectangle.css({top:t.pixels.origin.y+"px",left:t.pixels.origin.x+"px",width:t.pixels.hypo+"px",height:"0px"})):(this.elements.diagonal.css({opacity:"0.5"}),this.elements.rectangle.css({top:t.pixels.origin.y+t.pixels.correction.y+"px",left:t.pixels.origin.x+t.pixels.correction.x+"px",width:t.pixels.hypo+"px",height:2*t.pixels.adjacent+"px"}))),i={transform:"rotate("+s+"rad)",msTransform:"rotate("+s+"rad)","-o-transform":"rotate("+s+"rad)","-ms-transform":"rotate("+s+"rad)","-moz-transform":"rotate("+s+"rad)","-sand-transform":"rotate("+s+"rad)","-webkit-transform":"rotate("+s+"rad)"},this.elements.rectangle.css(i),this.elements.diagonal.css(i)},e}(),this.BBoxAnnotator=function(){function s(e,t){void 0!==t||(t={}),void 0!==t.prefix||(t.prefix=""),void 0!==t.ids||(t.ids={}),void 0!==t.ids.container||(t.ids.container=t.prefix+"bbox-annotator-container"),void 0!==t.ids.resize||(t.ids.resize=t.prefix+"bbox-annotator-bbox-resize"),void 0!==t.props||(t.props={}),void 0!==t.props.rotate||(t.props.rotate=t.prefix+"bbox-annotator-bbox-rotate-handle"),void 0!==t.props.resize||(t.props.resize=t.prefix+"bbox-annotator-bbox-resize-handle"),void 0!==t.classes||(t.classes={}),void 0!==t.classes.bbox||(t.classes.bbox=t.prefix+"bbox-annotator-bbox"),void 0!==t.classes.assignment||(t.classes.assignment=t.prefix+"bbox-annotator-bbox-assignment"),void 0!==t.classes.label||(t.classes.label=t.prefix+"bbox-annotator-bbox-label"),void 0!==t.classes.close||(t.classes.close=t.prefix+"bbox-annotator-bbox-close"),void 0!==t.classes.rotate||(t.classes.rotate=t.prefix+"bbox-annotator-bbox-rotate"),void 0!==t.classes.resize||(t.classes.resize=t.prefix+"bbox-annotator-bbox-resize"),void 0!==t.colors||(t.colors={}),void 0!==t.colors.default||(t.colors.default="#7FFF7F"),void 0!==t.colors.hover||(t.colors.hover="#F0AD4E"),void 0!==t.colors.focus||(t.colors.focus="#EB2A18"),void 0!==t.colors.anchor||(t.colors.anchor="#EB2A18"),void 0!==t.colors.subentry||(t.colors.subentry="#444444"),void 0!==t.colors.highlighted||(t.colors.highlighted="#2E63FF"),void 0!==t.colors.transparent||(t.colors.transparent=.25),void 0!==t.actions||(t.actions={}),void 0!==t.actions.entry||(t.actions.entry={}),void 0!==t.actions.entry.addition||(t.actions.entry.addition=!0),void 0!==t.actions.entry.parts||(t.actions.entry.parts=!0),void 0!==t.actions.entry.translation||(t.actions.entry.translation=!0),void 0!==t.actions.entry.scaling||(t.actions.entry.scaling=!0),void 0!==t.actions.entry.rotation||(t.actions.entry.rotation=!0),void 0!==t.actions.entry.deletion||(t.actions.entry.deletion=!0),void 0!==t.actions.subentry||(t.actions.subentry={}),void 0!==t.actions.subentry.addition||(t.actions.subentry.addition=!0),void 0!==t.actions.subentry.parts||(t.actions.subentry.parts=!0),void 0!==t.actions.subentry.translation||(t.actions.subentry.translation=!0),void 0!==t.actions.subentry.scaling||(t.actions.subentry.scaling=!0),void 0!==t.actions.subentry.rotation||(t.actions.subentry.rotation=!0),void 0!==t.actions.subentry.deletion||(t.actions.subentry.deletion=!0),void 0!==t.hotkeys||(t.hotkeys={}),void 0!==t.hotkeys.enabled||(t.hotkeys.enabled=!0),void 0!==t.hotkeys.delete||(t.hotkeys.delete=[8,46,75]),void 0!==t.hotkeys.exit||(t.hotkeys.exit=[27]),void 0!==t.hotkeys.zoom||(t.hotkeys.zoom=[90]),void 0!==t.hotkeys.background||(t.hotkeys.background=[66]),void 0!==t.hotkeys.focus||(t.hotkeys.focus=[70]),void 0!==t.hotkeys.counterclockwise||(t.hotkeys.counterclockwise=[76]),void 0!==t.hotkeys.clockwise||(t.hotkeys.clockwise=[82]),void 0!==t.hotkeys.left||(t.hotkeys.left=[37]),void 0!==t.hotkeys.up||(t.hotkeys.up=[38]),void 0!==t.hotkeys.right||(t.hotkeys.right=[39]),void 0!==t.hotkeys.down||(t.hotkeys.down=[40]),void 0!==t.handles||(t.handles={}),void 0!==t.handles.rotate||(t.handles.rotate={}),void 0!==t.handles.rotate.enabled||(t.handles.rotate.enabled=!0),void 0!==t.handles.rotate.diameter||(t.handles.rotate.diameter=10),void 0!==t.handles.resize||(t.handles.resize={}),void 0!==t.handles.resize.enabled||(t.handles.resize.enabled=!0),void 0!==t.handles.resize.diameter||(t.handles.resize.diameter=8),void 0!==t.handles.close||(t.handles.close={}),void 0!==t.handles.close.enabled||(t.handles.close.enabled=!1),void 0!==t.border||(t.border={}),void 0!==t.border.color||(t.border.color=t.colors.default),void 0!==t.border.width||(t.border.width=2),void 0!==t.steps||(t.steps={}),void 0!==t.steps.move||(t.steps.move=10),void 0!==t.steps.rotate||(t.steps.rotate=Math.PI/4),void 0!==t.subentries||(t.subentries={}),void 0!==t.subentries.visible||(t.subentries.visible=null),void 0!==t.subentries.assignments||(t.subentries.assignments=!1),void 0!==t.subentries.label||(t.subentries.label=!0),void 0!==t.limits||(t.limits={}),void 0!==t.limits.frame||(t.limits.frame={}),void 0!==t.limits.frame.width||(t.limits.frame.width=1e3),void 0!==t.limits.frame.height||(t.limits.frame.height=700),void 0!==t.limits.entry||(t.limits.entry={}),void 0!==t.limits.entry.area||(t.limits.entry.area=100),void 0!==t.limits.entry.width||(t.limits.entry.width=10),void 0!==t.limits.entry.height||(t.limits.entry.height=10),void 0!==t.limits.bounds||(t.limits.bounds={}),void 0!==t.limits.bounds.x||(t.limits.bounds.x={}),void 0!==t.limits.bounds.x.min||(t.limits.bounds.x.min=50),void 0!==t.limits.bounds.x.max||(t.limits.bounds.x.max=50),void 0!==t.limits.bounds.y||(t.limits.bounds.y={}),void 0!==t.limits.bounds.y.min||(t.limits.bounds.y.min=50),void 0!==t.limits.bounds.y.max||(t.limits.bounds.y.max=50),void 0!==t.confirm||(t.confirm={}),void 0!==t.confirm.delete||(t.confirm.delete=!0),void 0!==t.callbacks||(t.callbacks={}),void 0!==t.callbacks.onload||(t.callbacks.onload=null),void 0!==t.callbacks.onadd||(t.callbacks.onadd=null),void 0!==t.callbacks.onselector||(t.callbacks.onselector=null),void 0!==t.callbacks.onchange||(t.callbacks.onchange=null),void 0!==t.callbacks.onhover||(t.callbacks.onhover=null),void 0!==t.callbacks.onfocus||(t.callbacks.onfocus=null),void 0!==t.callbacks.ondelete||(t.callbacks.ondelete=null),void 0!==t.modes||(t.modes=["rectangle","diagonal","diagonal2"]),void 0!==t.mode||(t.mode="rectangle"),void 0!==t.debug||(t.debug=!1),this.options=t,this.entries=[],this.elements={entries:[]},this.debug=[],this.state={mode:"free",hover:null,hover2:null,subentry:null,focus:null,focus2:null,drag:!1,which:null,inside:!1,zoom:!1,anchors:{}},this.create_annotator_elements(e)}return s.prototype.create_annotator_elements=function(t){var s,i;if(s=this,this.elements.container=$("#"+this.options.ids.container),this.elements.container.css({width:"100%","margin-left":"auto","margin-right":"auto"}),this.elements.frame=$('<div class="ia-bbox-annotator-frame"></div>'),this.elements.frame.css({position:"relative",width:"100%",height:"100%",border:"#333333 solid 1px",margin:"0px auto","background-size":"100% auto","background-repeat":"no-repeat",overflow:"hidden",cursor:"crosshair"}),this.elements.container.append(this.elements.frame),this.options.debug){i={left:"0.0",top:"0.0",width:"10px",height:"10px",position:"absolute","border-radius":"10px",border:"1px solid #fff","margin-top":"-6px","margin-left":"-6px"},colors=["red","green","blue","purple"];for(var o=0;o<colors.length;o++)this.debug.push($("<div></div>")),this.debug[o].css(i),this.debug[o].css({"background-color":colors[o]}),this.elements.frame.append(this.debug)}this.elements.image=new Image,this.elements.image.src=t,this.elements.image.onload=function(){if(s.elements.frame.css({"background-image":'url("'+this.src+'")'}),s.bbs=new e(s.elements.frame,s.options),s.register_global_key_bindings(),s.register_global_event_bindings(),s.resize(),null!=s.options.callbacks.onload)return s.options.callbacks.onload()},this.elements.image.onerror=function(){console.log.text("[BBoxAnnotator] Invalid image URL provided: "+this.url)}},s.prototype.delete_entry_interaction=function(e,t){if(entry=bba.entries[t],e.shiftKey&&null==entry.parent){if(this.options.confirm.delete&&(response=confirm("Are you sure you want to delete all sub-entries?"),!response))return;for(var s=0;s<bba.entries.length;s++){null!=(i=bba.entries[s].parent)&&i==t&&(t=bba.delete_entry(s,t),s=0)}}else{if(this.options.confirm.delete&&null==entry.parent&&null!=entry.label&&(response=confirm("Are you sure you want to delete this box?"),!response))return;for(s=0;s<bba.entries.length;s++){var i;null!=(i=bba.entries[s].parent)&&i==t&&(t=bba.delete_entry(s,t),s=0)}bba.delete_entry(t)}},s.prototype.register_global_key_bindings=function(e,t){var s;s=this,$(window).keydown(function(e){var t;if(t=e.which,-1!=s.options.hotkeys.zoom.indexOf(t)&&(s.state.zoom?s.zoom_finish():s.options.hotkeys.enabled&&s.zoom_start()),s.options.hotkeys.enabled){if(-1!=s.options.hotkeys.delete.indexOf(t))if(e.preventDefault(),"selector"==s.state.mode)s.selector_cancel(e);else{if("drag"==s.state.mode)return;if("rotate"==s.state.mode)return;if("resize"==s.state.mode)return;null!=s.state.focus2?(s.focus_entry(s.state.focus2),null==s.state.hover&&s.subentries_style_visible(null)):null!=s.state.focus?null==s.state.hover||s.state.hover==s.state.focus?(s.focus_entry(s.state.focus),null==s.state.hover&&s.subentries_style_visible(null)):null!=s.state.hover&&s.delete_entry_interaction(e,s.state.hover):s.delete_entry_interaction(e,s.state.hover)}if(-1!=s.options.hotkeys.exit.indexOf(t))if("selector"==s.state.mode)s.selector_cancel(e);else{if("drag"==s.state.mode)return;if("rotate"==s.state.mode)return;if("resize"==s.state.mode)return;null!=s.state.focus&&(s.focus_entry(s.state.focus),null==s.state.hover&&s.subentries_style_visible(null))}-1!=s.options.hotkeys.focus.indexOf(t)&&(null!=s.state.hover?s.focus_entry(s.state.hover):null!=s.state.focus&&(s.focus_entry(s.state.focus),null==s.state.hover&&s.subentries_style_visible(null))),null!=s.state.focus&&s.state.focus==s.state.hover||(-1!=[].concat(s.options.hotkeys.up).concat(s.options.hotkeys.down).concat(s.options.hotkeys.left).concat(s.options.hotkeys.right).indexOf(t)&&(correction={x:0,y:0},-1!=s.options.hotkeys.left.indexOf(t)&&(correction.x=-1),-1!=s.options.hotkeys.up.indexOf(t)&&(correction.y=-1),-1!=s.options.hotkeys.right.indexOf(t)&&(correction.x=1),-1!=s.options.hotkeys.down.indexOf(t)&&(correction.y=1),e.shiftKey&&(correction.x*=s.options.steps.move,correction.y*=s.options.steps.move),s.move_entry_correction(e,correction)),-1!=s.options.hotkeys.background.indexOf(t)&&s.background_entry(e,s.state.hover),-1!=s.options.hotkeys.counterclockwise.indexOf(t)&&s.orient_entry(e,"left"),-1!=s.options.hotkeys.clockwise.indexOf(t)&&s.orient_entry(e,"right"))}})},s.prototype.register_global_event_bindings=function(e,t){var s;s=this,$(window).bind("resize",function(){s.resize()}),this.elements.container.mousedown(function(e){s.state.inside=!0,"rotate"!=s.state.mode&&"resize"!=s.state.mode&&s.drag_start(e)}),this.elements.container.contextmenu(function(e){e.preventDefault()}),$(window).mousemove(function(e){if("selector"==s.state.mode)s.selector_update(e);else if(s.state.drag&&"drag"!=s.state.mode&&"magnet"!=s.state.mode)if(3==s.state.which)s.state.mode="magnet",element=s.elements.entries[s.state.hover],entry=s.entries[s.state.hover],resize_handle=element.resize[entry.closest],s.resize_start(resize_handle,e);else if(null!=s.state.hover){if(s.state.mode="drag",element=s.elements.entries[s.state.hover],null!=s.state.focus&&s.state.focus==s.state.hover||(s.entries_style_transparent(s.options.colors.transparent,s.state.hover),entry=s.entries[s.state.hover],null!=entry.parent&&(element2=s.elements.entries[entry.parent],element2.bbox.css({opacity:1})),element.label.hide()),!s.options.debug){element.close.hide(),element.rotate.hide();for(var t in element.resize)element.resize[t].hide()}s.anchor_update(e,null)}else s.state.mode="junk",s.drag_finish();"free"==s.state.mode&&null!=s.state.hover&&s.anchor_entry(e),"drag"==s.state.mode&&s.move_entry(e),"rotate"==s.state.mode&&s.rotate_entry(e),"resize"==s.state.mode&&s.resize_entry(e),"magnet"==s.state.mode&&s.resize_entry(e)}),$(window).mouseup(function(e){if(1==e.which)if("free"==s.state.mode&&s.state.inside)null==s.state.focus2&&s.selector_start(e);else if("selector"==s.state.mode)s.selector_stage(e);else if("drag"==s.state.mode){if(null!=s.state.hover&&(entry=s.entries[s.state.hover],i=s.elements.entries[s.state.hover],void 0!==entry&&void 0!==i&&(s.label_entry(s.state.hover,entry.label),(null==s.state.focus||s.state.focus!=s.state.hover)&&null==s.state.focus2))){s.entries_style_transparent(1),s.options.handles.close.enabled&&i.close.show(),s.options.handles.rotate.enabled&&i.rotate.show();for(var t in i.resize)s.options.handles.resize.enabled&&i.resize[t].show()}s.state.mode="free"}else if("rotate"==s.state.mode){var i;if(s.entries_style_transparent(1),null!=s.state.hover&&(entry=s.entries[s.state.hover],i=s.elements.entries[s.state.hover],void 0!==entry&&void 0!==i)){s.label_entry(s.state.hover,entry.label),s.options.handles.close.enabled&&i.close.show();for(var t in i.resize)s.options.handles.resize.enabled&&i.resize[t].show()}document.onselectstart=null,s.state.mode="free"}else"resize"==s.state.mode?s.resize_finish(e):"close"==s.state.mode?s.state.mode="free":"junk"==s.state.mode&&(s.state.mode="free");else 3==e.which&&("magnet"==s.state.mode?s.resize_finish(e):null!=s.state.hover?s.focus_entry(s.state.hover):null!=s.state.focus&&s.focus_entry(s.state.focus));s.drag_finish(),s.state.inside=!1})},s.prototype.resize=function(){var e,t,s,i,o,n;zoom=this.state.zoom,width=$(window).width(),height=$(window).height(),e=this.elements.image.width,t=this.elements.image.height,zoom?(s=(i=height-10)/t*e,s=Math.min(s,width-10)):(s=this.elements.container.width(),limit1=this.options.limits.frame.width,limit2=this.options.limits.frame.height/t*e,s=Math.min(s,this.options.limits.frame.width,limit2)),i=s/e*t,zoom?(n=-1*(o=this.elements.container.offset()).left,n+=.5*(width-s),n+="px",scroll=o.top-5):(n="",scroll=0),$("html, body").animate({scrollTop:scroll}),this.elements.frame.css({width:s+"px",height:i+"px",left:n}),this.elements.container.css({height:i+"px",width:s+"px"});for(var r=0;r<this.entries.length;r++)entry=this.entries[r],void 0!==entry&&null==entry.parent&&this.assignment_entry(r);this.refresh()},s.prototype.zoom_start=function(){this.state.zoom=!0,this.resize()},s.prototype.zoom_finish=function(){this.state.zoom=!1,this.resize()},s.prototype.update_mode=function(e){this.selector_cancel(null),this.options.mode=this.bbs.update_mode(e)},s.prototype.refresh=function(){if(null!=this.options.callbacks.onchange)return this.options.callbacks.onchange(this.entries)},s.prototype.delete_entry=function(e,t){var s,i,o;if(void 0!==t||(t=null),null!=e){for(var n=0;n<this.entries.length;n++){null!=(l=this.entries[n].parent)&&l==e&&(e=this.delete_entry(n,e),n=0)}s=[];for(var r=0;r<this.entries.length;r++)s.push(r);i=this.entries.splice(e,1),s.splice(e,1),(o=this.elements.entries.splice(e,1))[0].bbox.detach(),null!=o[0].assignment&&o[0].assignment.detach();for(n=0;n<this.entries.length;n++){var l;null!=(l=this.entries[n].parent)&&(this.entries[n].parent=s.indexOf(l))}return this.refresh(),null!=bba.options.callbacks.ondelete?bba.options.callbacks.ondelete(i[0]):null==t?null:s.indexOf(t)}},s.prototype.rotate_element=function(e,t){var s;s={transform:"rotate("+t+"rad)",msTransform:"rotate("+t+"rad)","-o-transform":"rotate("+t+"rad)","-ms-transform":"rotate("+t+"rad)","-moz-transform":"rotate("+t+"rad)","-sand-transform":"rotate("+t+"rad)","-webkit-transform":"rotate("+t+"rad)"},e.css(s)},s.prototype.add_entry=function(e,t){var s,i,o,n,r,l,a,h,d,c;if(void 0!==t||(t=!1),s=!1,void 0!==e.percent||(s=!0),void 0!==e.angles||(s=!0),s)return console.log("[BBoxAnnotator] Invalid entry provided: no bounding box dimensions"),void console.log(e);if(void 0!==e.percent.top||(s=!0),void 0!==e.percent.left||(s=!0),void 0!==e.percent.width||(s=!0),void 0!==e.percent.height||(s=!0),void 0!==e.angles.theta||(s=!0),s)return console.log("[BBoxAnnotator] Invalid entry provided: incomplete bounding box dimensions and/or angle"),void console.log(e);i=this.elements.frame.width(),o=this.elements.frame.height(),e.pixels={},e.pixels.left=e.percent.left/100*i,e.pixels.top=e.percent.top/100*o,e.pixels.width=e.percent.width/100*i,e.pixels.height=e.percent.height/100*o,void 0!==e.label||(e.label=null),void 0!==e.parent||(e.parent=null),null==e.parent&&null!=this.state.focus&&(e.parent=this.state.focus),void 0!==e.metadata||(e.metadata={}),void 0!==e.highlighted||(e.highlighted=!1),void 0!==e.closest||(e.closest=null),console.log("[BBoxAnnotator] Adding entry for:"),console.log(e),r={"user-select":"none","-o-user-select":"none","-moz-user-select":"none","-khtml-user-select":"none","-webkit-user-select":"none"},(n={}).bbox=$('<div class="'+this.options.classes.bbox+'"></div>'),n.bbox.css({position:"absolute",top:e.percent.top+"%",left:e.percent.left+"%",width:e.percent.width+"%",height:e.percent.height+"%",border:this.options.border.width+"px solid "+this.options.colors.default,"border-top":1.5*this.options.border.width+"px dotted "+this.options.colors.default,color:"#FFFFFF","font-family":"monospace","font-size":"0px"}),n.bbox.css(r),null!=e.parent&&n.bbox.css({outline:this.options.border.width+"px solid "+this.options.colors.subentry}),this.rotate_element(n.bbox,e.angles.theta),this.elements.frame.append(n.bbox),null!=e.parent?(n.assignment=$('<div id="'+this.options.classes.assignment+'"></div>'),n.assignment.css({height:"0%","border-top":"1px solid "+this.options.border.color,position:"absolute","transform-origin":"0% 0%"}),this.elements.frame.append(n.assignment),this.options.subentries.assignments||n.assignment.hide()):n.assignment=null,n.label=$('<div class="'+this.options.classes.label+'"></div>'),n.label.css({overflow:"visible",display:"inline-block","background-color":this.options.colors.default,opacity:"0.8",color:"#333333",padding:"1px 3px","font-size":"12px"}),n.bbox.append(n.label),n.close=$('<div class="'+this.options.classes.close+'"></div>'),n.close.css({position:"absolute",top:"5px",right:"5px",width:"20px",height:"0",border:"2px solid #FFFFFF","margin-left":"-10px",padding:"16px 0 0 0",color:"#FFFFFF","background-color":"#003300",cursor:"pointer","text-align":"center",overflow:"visible","border-radius":"18px","-moz-border-radius":"18px","-webkit-border-radius":"18px"}),n.bbox.append(n.close),temp=$("<div></div>"),temp.html("&#215").css({position:"absolute",top:"-2px",left:"0",width:"16px",display:"block","text-align":"center","font-size":"20px","line-height":"20px"}),n.close.append(temp),this.options.handles.close.enabled||n.close.hide(),l=Math.floor(.5*(this.options.handles.rotate.diameter+2)),a={position:"absolute",width:this.options.handles.rotate.diameter+"px",height:this.options.handles.rotate.diameter+"px","margin-right":"-"+l+"px","margin-top":"-"+l+"px",border:"1px solid #333333",cursor:"pointer","border-radius":this.options.handles.rotate.diameter+"px","-moz-border-radius":this.options.handles.rotate.diameter+"px","-webkit-border-radius":this.options.handles.rotate.diameter+"px","background-color":this.options.colors.default},n.rotate=$('<div class="'+this.options.classes.rotate+'"></div>'),n.rotate.prop(this.options.props.rotate,"true"),n.rotate.css(a),n.rotate.css({top:"15px",right:"50%"}),this.options.handles.rotate.enabled||n.rotate.hide(),n.bbox.append(n.rotate),l=Math.floor(.5*(this.options.handles.resize.diameter+2)),a={position:"absolute",width:this.options.handles.resize.diameter+"px",height:this.options.handles.resize.diameter+"px","margin-right":"-"+l+"px","margin-top":"-"+l+"px",border:"1px solid #333333",cursor:"pointer","border-radius":this.options.handles.resize.diameter+"px","-moz-border-radius":this.options.handles.resize.diameter+"px","-webkit-border-radius":this.options.handles.resize.diameter+"px","background-color":"#FFFFFF"},h={nw:{top:"0px",left:"-6px"},n:{top:"0px",right:"50%"},ne:{top:"0px",right:"0px"},e:{top:"50%",right:"0px"},se:{right:"0px",bottom:"-6px"},s:{right:"50%",bottom:"-6px"},sw:{left:"-6px",bottom:"-6px"},w:{top:"50%",left:"-6px"}},n.resize={};for(var p in h)(d=$('<div id="'+this.options.ids.resize+"-"+p+'" class="'+this.options.classes.resize+'"></div>')).prop(this.options.props.resize,p),d.css(a),d.css(h[p]),this.options.handles.resize.enabled||d.hide(),n.bbox.append(d),n.resize[p]=d;return this.register_entry_event_bindings(n),this.entries.push(e),this.elements.entries.push(n),c=this.entries.length-1,this.label_entry(c,e.label),null==this.state.focus&&(this.hover_entry(null),this.entries_style_visible()),this.assignment_entry(c),t&&null!=this.options.callbacks.onadd&&this.options.callbacks.onadd(e),this.refresh(),c},s.prototype.hover_entry=function(e){var t;if(this.state.hover2=e,"selector"!=this.state.mode&&"drag"!=this.state.mode&&"magnet"!=this.state.mode&&"rotate"!=this.state.mode&&"resize"!=this.state.mode&&null==this.state.focus2){if(this.state.subentry=null,null!=e&&null==this.state.focus&&void 0!==(t=this.entries[e])&&null!=t.parent&&(this.state.subentry=e,e=t.parent),this.state.hover=e,null==this.state.focus)if(null!=e)this.entry_style_hover(e),this.subentries_style_visible(e);else{for(e=0;e<this.elements.entries.length;e++)this.entry_style_default(e);this.subentries_style_visible(null)}else if(this.state.focus!=e)if(null!=e)this.entry_style_hover(e);else for(var s=0;s<this.elements.entries.length;s++)void 0!==(t=this.entries[s])&&null!=t.parent&&t.parent==this.state.focus&&this.entry_style_default(s);return null!=this.options.callbacks.onhover?null==this.state.focus?(t=null==this.state.hover?null:this.entries[this.state.hover],this.options.callbacks.onhover(this.state.hover,t)):null==this.state.hover?(t=this.entries[this.state.focus],this.options.callbacks.onhover(this.state.focus,t)):(t=this.entries[this.state.hover],this.options.callbacks.onhover(this.state.hover,t)):void 0}},s.prototype.focus_entry=function(e){if(null!=e){if(null==this.state.focus)this.state.focus=e,this.state.focus2=null,i=this.entries[e],this.entry_style_focus(e),this.entries_style_hidden(e),this.subentries_style_visible(e),null!=this.state.subentry&&this.hover_entry(this.state.subentry);else if(e!=this.state.focus)if(null==this.state.focus2){var t;this.state.focus2=e,this.entry_style_focus(e),t={opacity:this.options.colors.transparent};for(var s=0;s<this.elements.entries.length;s++){(i=this.entries[s]).parent==this.state.focus&&this.state.focus2!=s&&((o=this.elements.entries[s]).bbox.css(t),null!=o.assignment&&o.assignment.css(t))}if(null!=this.options.callbacks.onfocus)return i=null==this.state.focus2?null:this.entries[this.state.focus2],this.options.callbacks.onfocus(this.state.focus2,i)}else{this.state.hover2==this.state.focus2?this.entry_style_hover(this.state.focus2):this.entry_style_default(this.state.focus2),this.state.focus2=null,this.state.hover=this.state.hover2,t={opacity:1};for(s=0;s<this.elements.entries.length;s++){var i,o;(i=this.entries[s]).parent==this.state.focus&&((o=this.elements.entries[s]).bbox.css(t),null!=o.assignment&&o.assignment.css(t))}this.hover_entry(this.state.hover)}else{for(s=0;s<this.elements.entries.length;s++)null!=(i=this.entries[s]).parent&&i.parent==this.state.focus&&this.entry_style_default(s);this.state.focus=null,this.hover_entry(this.state.hover),this.entries_style_visible(e),this.subentries_style_visible(e)}return null!=this.options.callbacks.onfocus?(i=null==this.state.focus?null:this.entries[this.state.focus],this.options.callbacks.onfocus(this.state.focus,i)):void 0}},s.prototype.anchor_update=function(e,t){var s,i,o,n,r;if(null!=(s=this.state.hover)){entry=this.entries[s],i=this.elements.entries[s],o=this.elements.container.offset(),this.rotate_element(i.bbox,0),n=i.bbox.position(),this.state.anchors={},this.state.anchors.cursor={x:e.pageX-o.left,y:e.pageY-o.top},this.state.anchors.element={x:n.left,y:n.top,width:i.bbox.width()+2*this.options.border.width,height:i.bbox.height()+2*this.options.border.width,theta:entry.angles.theta,right:entry.angles.theta-.5*Math.PI,handle:t},this.rotate_element(i.bbox,entry.angles.theta),n=i.bbox.position(),this.state.anchors.resize={};for(var l in i.resize)r=i.resize[l].position(),this.state.anchors.resize[l]={x:n.left+r.left,y:n.top+r.top}}},s.prototype.label_entry=function(e,t){var s,i,o,n;s=this.entries[e],i=this.elements.entries[e],s.label=t,o=null,null==s.parent&&null!=s.label?(o=s.label,n=12):null!=s.parent&&null!=s.metadata.type&&this.options.subentries.label&&"____"!=s.metadata.type&&(o=s.metadata.type,n=9),i.label.css({"font-size":n+"px"}),null!=o||s.highlighted?(null==o&&(o=""),s.highlighted?(o="*",i.label.html(o)):o="",i.label.html(o),i.label.show()):i.label.hide()},s.prototype.get_metadata=function(){var e;return null==(e=this.state.hover)&&null==(e=this.state.focus)?null:this.entries[e].metadata},s.prototype.set_metadata=function(e){var t,s;if(null==(t=this.state.hover)&&null==(t=this.state.focus))return null;(s=this.entries[t]).metadata=e,this.label_entry(t,s.label),this.refresh()},s.prototype.set_highlighted=function(e){var t,s;if(null==(t=this.state.hover)&&null==(t=this.state.focus))return null;(s=this.entries[t]).highlighted=e,this.label_entry(t,s.label),this.refresh()},s.prototype.anchor_entry=function(e){var t,s,i,o,n,r,l,a,h,d;if(t=this.state.hover,null==this.state.focus&&(s=this.entries[t],i=this.elements.entries[t],void 0!==s&&void 0!==i)){o=1/0,n=null;for(var c in i.resize)l=(r=i.resize[c]).offset(),a=e.pageX-l.left,h=e.pageY-l.top,(d=Math.sqrt(Math.pow(a,2)+Math.pow(h,2)))<o&&(o=d,n=c),r.css({"background-color":"#FFFFFF"});s.closest=n,(r=i.resize[n]).css({"background-color":this.options.colors.anchor})}},s.prototype.assignment_entry=function(e){var s,i,o,n,r,l,a,h,d;if(null!=e){if(s=this.entries[e],i=this.elements.entries[e],null==s.parent)for(var c=0;c<this.entries.length;c++)null!=(s=this.entries[c]).parent&&s.parent==e&&this.assignment_entry(c);null!=i.assignment&&(o=this.entries[s.parent],n=this.elements.frame.width(),r=this.elements.frame.height(),(l={}).entry={x:(s.percent.left+.5*s.percent.width)/100*n,y:(s.percent.top+.5*s.percent.height)/100*r},l.parent={x:(o.percent.left+.5*o.percent.width)/100*n,y:(o.percent.top+.5*o.percent.height)/100*r},a={x:l.entry.x-l.parent.x,y:l.entry.y-l.parent.y},h=Math.sqrt(Math.pow(a.x,2)+Math.pow(a.y,2)),d=t(l.entry,l.parent),i.assignment.css({top:s.percent.top+.5*s.percent.height+"%",left:s.percent.left+.5*s.percent.width+"%",width:h+"px"}),this.rotate_element(i.assignment,d))}},s.prototype.move_entry=function(e){var t,s,i,o,n,r;null!=(t=this.state.hover)&&null==this.state.focus2&&(null!=this.state.focus&&(s=this.entries[t]).parent!=this.state.focus||(s=this.entries[t],i=this.elements.entries[t],void 0!==s&&void 0!==i&&(o=this.elements.container.offset(),o={x:e.pageX-o.left-this.state.anchors.cursor.x,y:e.pageY-o.top-this.state.anchors.cursor.y},s.pixels.left=this.state.anchors.element.x+o.x,s.pixels.top=this.state.anchors.element.y+o.y,n=this.elements.frame.width(),r=this.elements.frame.height(),s.percent.left=100*s.pixels.left/n,s.percent.top=100*s.pixels.top/r,i.bbox.css({top:s.percent.top+"%",left:s.percent.left+"%"}),this.assignment_entry(t),this.refresh())))},s.prototype.move_entry_correction=function(e,t){var s,i,o,n,r;null!=(s=this.state.hover)&&null==this.state.focus2&&(e.preventDefault(),entry=this.entries[s],i=this.elements.entries[s],this.rotate_element(i.bbox,0),o=i.bbox.position(),this.rotate_element(i.bbox,entry.angles.theta),entry.pixels.left=o.left+t.x,entry.pixels.top=o.top+t.y,n=this.elements.frame.width(),r=this.elements.frame.height(),entry.percent.left=100*entry.pixels.left/n,entry.percent.top=100*entry.pixels.top/r,i.bbox.css({top:entry.percent.top+"%",left:entry.percent.left+"%"}),this.assignment_entry(s),this.refresh())},s.prototype.rotate_entry=function(e){var s,i,o,n,r,l,a,h,d;null!=(s=this.state.hover)&&null==this.state.focus2&&(i=this.entries[s],o=this.elements.entries[s],n=this.elements.container.offset(),r={x:this.state.anchors.element.x+.5*this.state.anchors.element.width,y:this.state.anchors.element.y+.5*this.state.anchors.element.height},l={x:e.pageX-n.left,y:e.pageY-n.top},(a={}).anchor=t(r,this.state.anchors.cursor),a.cursor=t(r,l),h=a.cursor-a.anchor,d=this.state.anchors.element.theta+h,e.shiftKey&&(d/=this.options.steps.rotate,d=Math.round(d),d*=this.options.steps.rotate),i.angles.theta=d,this.rotate_element(o.bbox,i.angles.theta),this.assignment_entry(s),this.refresh())},s.prototype.orient_entry=function(e,t,s){var i,o,n,r,l;void 0!==s||(s=this.state.hover),null!=s&&("left"!=t&&"right"!=t||(i=this.entries[s],o=this.elements.entries[s],n=JSON.parse(JSON.stringify(i.percent)),r=this.elements.frame.width(),l=this.elements.frame.height(),center={x:n.left+.5*n.width,y:n.top+.5*n.height},i.percent.width=n.height*l/r,i.percent.height=n.width*r/l,i.percent.left=center.x-.5*i.percent.width,i.percent.top=center.y-.5*i.percent.height,o.bbox.css({top:i.percent.top+"%",left:i.percent.left+"%",width:i.percent.width+"%",height:i.percent.height+"%"}),"left"==t?i.angles.theta-=.5*Math.PI:i.angles.theta+=.5*Math.PI,this.rotate_element(o.bbox,i.angles.theta),this.refresh()))},s.prototype.background_entry=function(e,t,s){var i,o,n,r;if(void 0!==s||(s=!0),null!=t){if(null==(o=this.entries[t]).parent){if(null!=this.state.focus)return;for(var l=0;l<this.entries.length;l++){null!=(h=this.entries[l].parent)&&h==t&&(this.background_entry(o,l,!1),t+=1)}}else if(s){if(null==this.state.focus)return;if(null!=this.state.focus2)return;i=[];for(l=0;l<this.entries.length;l++){if(null!=(h=this.entries[l].parent)&&h==this.state.focus&&(i.push(l),l==t))break}return void(i.length>1&&(index_last=i[i.length-1],index_penultimate=i[i.length-2],entry_last=this.entries[index_last],element_last=this.elements.entries[index_last],entry_penultimate=this.entries[index_penultimate],element_penultimate=this.elements.entries[index_penultimate],this.entries[index_last]=entry_penultimate,this.elements.entries[index_last]=element_penultimate,this.entries[index_penultimate]=entry_last,this.elements.entries[index_penultimate]=element_last,element_last.bbox.swapWith(element_penultimate.bbox),this.background_entry(e,index_penultimate)))}i=[];for(var a=0;a<this.entries.length;a++)i.push(a);o=this.entries.splice(t,1),this.entries.unshift(o[0]),o=i.splice(t,1),i.unshift(o[0]),n=this.elements.entries.splice(t,1),this.elements.entries.unshift(n[0]),r=n[0].bbox.detach(),this.elements.frame.prepend(r);for(t=0;t<this.entries.length;t++){var h;null!=(h=this.entries[t].parent)&&(this.entries[t].parent=i.indexOf(h))}this.refresh()}},s.prototype.resize_start=function(e,t){var s,i,o,n;for(parent=e.parent("."+bba.options.classes.bbox),r=parent.prevAll("."+bba.options.classes.bbox).length,s=bba.entries[r],i=bba.elements.entries[r],o=e.prop(bba.options.props.resize),bba.entries_style_transparent(bba.options.colors.transparent,r),null!=s.parent&&(element2=bba.elements.entries[s.parent],element2.bbox.css({opacity:1})),bba.state.orientation=Math.floor(s.angles.theta/(.5*Math.PI));bba.state.orientation<0;)bba.state.orientation+=4;for(;bba.state.orientation>4;)bba.state.orientation-=4;bba.state.orientation=Math.floor(bba.state.orientation),0==bba.state.orientation?n=null:1==bba.state.orientation?n="border-right":2==bba.state.orientation?n="border-bottom":3==bba.state.orientation&&(n="border-left"),null!=n&&(i.bbox.css("border-top",bba.options.border.width+"px solid"+bba.options.colors.hover),i.bbox.css(n,1.5*bba.options.border.width+"px dotted "+bba.options.colors.hover));for(var r=bba.state.orientation;r>0;r--)bba.orient_entry(t,"left"),"nw"==o?o="ne":"n"==o?o="e":"ne"==o?o="se":"e"==o?o="s":"se"==o?o="sw":"s"==o?o="w":"sw"==o?o="nw":"w"==o&&(o="n");bba.options.debug||(i.label.hide(),i.close.hide(),i.rotate.hide()),document.onselectstart=function(){return!1},bba.anchor_update(t,o)},s.prototype.resize_finish=function(e){for(var t,s=bba.state.orientation;s>0;s--)bba.orient_entry(e,"right");bba.entries_style_transparent(1),null!=bba.state.hover&&(entry=bba.entries[bba.state.hover],(t=bba.elements.entries[bba.state.hover]).bbox.css({border:bba.options.border.width+"px solid "+bba.options.colors.hover,"border-top":1.5*bba.options.border.width+"px dotted "+bba.options.colors.hover}),bba.label_entry(bba.state.hover,entry.label),bba.options.handles.close.enabled&&t.close.show(),bba.options.handles.rotate.enabled&&t.rotate.show()),document.onselectstart=null,bba.state.mode="free"},s.prototype.resize_entry=function(e){var s,i,o,n,r,l,a,h,d,c,p,u,b,m,f,y,x,g,v;if(s=this.state.hover,i=this.state.anchors.element.handle,null!=s&&null!=i){o=this.entries[s],n=this.elements.entries[s],b=this.elements.container.offset(),a={x:(l={x:e.pageX-b.left,y:e.pageY-b.top}).x-this.state.anchors.cursor.x,y:l.y-this.state.anchors.cursor.y},h=this.state.anchors.element.theta,d=Math.sqrt(Math.pow(a.x,2)+Math.pow(a.y,2)),c=t(this.state.anchors.cursor,l)-h,p={x:Math.cos(c)*d,y:Math.sin(c)*d},d=0,(u={x:{},y:{}}).x={x:Math.cos(h)*p.x,y:Math.sin(h)*p.x},u.x.hypo=Math.sqrt(Math.pow(u.x.x,2)+Math.pow(u.x.y,2)),u.x.x>0&&(u.x.hypo*=-1),u.y={x:Math.sin(-h)*p.y,y:Math.cos(-h)*p.y},u.y.hypo=Math.sqrt(Math.pow(u.y.x,2)+Math.pow(u.y.y,2)),u.y.y>0&&(u.y.hypo*=-1),"nw"==i?(r="se",b={x:u.x.x,y:u.y.y,width:u.x.hypo,height:u.y.hypo}):"n"==i?(r="s",b={x:0,y:u.y.y,width:0,height:u.y.hypo}):"ne"==i?(r="sw",b={x:0,y:u.y.y,width:-1*u.x.hypo,height:u.y.hypo}):"e"==i?(r="w",b={x:0,y:0,width:-1*u.x.hypo,height:0}):"se"==i?(r="nw",b={x:0,y:0,width:-1*u.x.hypo,height:-1*u.y.hypo}):"s"==i?(r="n",b={x:0,y:0,width:0,height:-1*u.y.hypo}):"sw"==i?(r="ne",b={x:u.x.x,y:0,width:u.x.hypo,height:-1*u.y.hypo}):"w"==i&&(r="e",b={x:u.x.x,y:0,width:u.x.hypo,height:0});for(var _ in n.resize)n.resize[_].css({"background-color":"#FFFFFF"});n.resize[i].css({"background-color":this.options.colors.anchor}),top=this.state.anchors.element.y+b.y,left=this.state.anchors.element.x+b.x,m=this.state.anchors.element.width+b.width,f=this.state.anchors.element.height+b.height,m<0||f<0||(o.pixels.width=m,o.pixels.height=f,m=this.elements.frame.width(),f=this.elements.frame.height(),o.percent.top=100*o.pixels.top/f,o.percent.left=100*o.pixels.left/m,o.percent.width=100*o.pixels.width/m,o.percent.height=100*o.pixels.height/f,n.bbox.css({top:o.percent.top+"%",left:o.percent.left+"%",width:o.percent.width+"%",height:o.percent.height+"%"}),y=n.bbox.position(),x=n.resize[r].position(),v={x:(g={x:y.left+x.left,y:y.top+x.top}).x-this.state.anchors.resize[r].x,y:g.y-this.state.anchors.resize[r].y},o.pixels.left-=v.x,o.pixels.top-=v.y,o.percent.left=100*o.pixels.left/m,o.percent.top=100*o.pixels.top/f,n.bbox.css({top:o.percent.top+"%",left:o.percent.left+"%"}),this.debug.length>0&&(this.debug[0].css({top:this.state.anchors.resize[r].y+"px",left:this.state.anchors.resize[r].x+"px"}),this.debug[1].css({top:g.y+"px",left:g.x+"px"}),this.debug[2].css({top:this.state.anchors.cursor.y+u.x.y+"px",left:this.state.anchors.cursor.x+u.x.x+"px"}),this.debug[3].css({top:this.state.anchors.cursor.y+u.y.y+"px",left:this.state.anchors.cursor.x+u.y.x+"px"})),this.assignment_entry(s),this.refresh())}},s.prototype.selector_start=function(e){if(!(null==this.state.focus&&0==this.options.actions.entry.addition||null!=this.state.focus&&0==this.options.actions.subentry.addition))return this.hover_entry(null),this.entries_style_transparent(this.options.colors.transparent),null!=this.state.focus&&(element=this.elements.entries[this.state.focus],element.bbox.css({opacity:1})),subentry=null!=this.state.focus,this.bbs.start(e,subentry),this.state.mode="selector",null!=this.options.callbacks.onselector?this.options.callbacks.onselector():void 0},s.prototype.selector_update=function(e){this.bbs.update_cursor(e)},s.prototype.selector_stage=function(e){this.bbs.stage(e)&&this.selector_finish(e)},s.prototype.selector_cancel=function(e){"selector"==this.state.mode&&(this.bbs.finish(e),this.state.mode="free",this.entries_style_transparent(1))},s.prototype.selector_finish=function(e){var t,s;"selector"==this.state.mode&&(t=this.bbs.finish(e),!1||isNaN(t.pixels.left)||isNaN(t.pixels.top)||isNaN(t.pixels.width)||isNaN(t.pixels.height)||t.pixels.width*t.pixels.height<=this.options.limits.entry.area||t.pixels.width<=this.options.limits.entry.width||t.pixels.height<=this.options.limits.entry.height||(s=this.add_entry(t,!0),"diagonal2"==this.options.mode&&(t.angles.fixed?bba.orient_entry(e,"right",s):bba.orient_entry(e,"left",s))),this.state.mode="free",this.entries_style_transparent(1))},s.prototype.entries_style_transparent=function(e,t){var s;void 0!==t||(t=null),s={opacity:e};for(var i=0;i<this.elements.entries.length;i++){var o;i!=t&&((o=this.elements.entries[i]).bbox.css(s),null!=o.assignment&&o.assignment.css(s))}},s.prototype.update_subentries_assignments=function(e){this.options.subentries.assignments=e,this.update_subentries_options()},s.prototype.update_subentries_visible=function(e){this.options.subentries.visible=e,this.update_subentries_options()},s.prototype.update_subentries_options=function(){if(null==this.state.focus)this.entries_style_visible(),this.options.subentries.visible||null==this.state.hover||this.subentries_style_visible(this.state.hover);else for(var e=0;e<this.elements.entries.length;e++)entry=this.entries[e],entry.parent==this.state.focus&&(element=this.elements.entries[e],0==this.options.subentries.visible?(element.bbox.hide(),null!=element.assignment&&element.assignment.hide()):(element.bbox.show(),null!=element.assignment&&(this.options.subentries.assignments?element.assignment.show():element.assignment.hide())))},s.prototype.entries_style_visible=function(e){var t,s;void 0!==e||(e=null);for(var i=0;i<this.elements.entries.length;i++)i!=e&&(t=this.entries[i],s=this.elements.entries[i],null==t.parent||1==this.options.subentries.visible?(s.bbox.show(),null!=s.assignment&&(this.options.subentries.assignments?s.assignment.show():s.assignment.hide())):(s.bbox.hide(),null!=s.assignment&&s.assignment.hide()))},s.prototype.subentries_style_visible=function(e){for(var t,s,i=0;i<this.elements.entries.length;i++)t=this.entries[i],s=this.elements.entries[i],null!=t.parent&&(t.parent==e&&0!=this.options.subentries.visible?(s.bbox.show(),null!=s.assignment&&(this.options.subentries.assignments?s.assignment.show():s.assignment.hide())):1!=this.options.subentries.visible&&(s.bbox.hide(),null!=s.assignment&&s.assignment.hide()))},s.prototype.entries_style_hidden=function(e){void 0!==e||(e=null);for(var t=0;t<this.elements.entries.length;t++)t!=e&&this.elements.entries[t].bbox.hide()},s.prototype.entry_style_default=function(e){var t,s,i,o;t=this.entries[e],s=this.elements.entries[e],i=t.highlighted?this.options.colors.highlighted:this.options.colors.default,s.bbox.css({"border-color":i,opacity:"0.8",cursor:"crosshair","background-color":"rgba(0, 0, 0, 0.0)","background-color":"rgba(0, 0, 0, 0.0)"}),null!=s.assignment&&s.assignment.css({"border-color":i}),null==t.parent?s.bbox.css({outline:"none"}):s.bbox.css({outline:this.options.border.width+"px solid "+this.options.colors.subentry}),o=t.highlighted?"#FFFFFF":"#333333",s.label.css({"background-color":i,opacity:"0.8",color:o}),s.close.hide(),s.rotate.hide();for(var n in s.resize)s.resize[n].hide()},s.prototype.entry_style_hover=function(e){var t,s;t=this.entries[e],(s=this.elements.entries[e]).bbox.css({"border-color":this.options.colors.hover,opacity:"1.0",cursor:"move","background-color":"rgba(0, 0, 0, 0.2)"}),null!=s.assignment&&s.assignment.css({"border-color":this.options.colors.hover}),null==t.parent?s.bbox.css({outline:"none"}):s.bbox.css({outline:this.options.border.width+"px solid "+this.options.colors.subentry}),s.label.css({"background-color":this.options.colors.hover,opacity:"1.0",color:"#333333"}),this.options.handles.close.enabled&&s.close.show(),this.options.handles.rotate.enabled&&s.rotate.show();for(var i in s.resize)this.options.handles.resize.enabled&&s.resize[i].show()},s.prototype.entry_style_focus=function(e){var t;entry=this.entries[e],(t=this.elements.entries[e]).bbox.css({outline:"1000px solid rgba(0, 0, 0, 0.2)","border-color":this.options.colors.focus,opacity:"1.0",cursor:"cell","background-color":"rgba(0, 0, 0, 0.0)"}),null!=t.assignment&&t.assignment.css({"border-color":this.options.colors.focus}),null!=entry.parent&&t.bbox.css({outline:this.options.border.width+"px solid "+this.options.colors.subentry}),t.label.css({"background-color":this.options.colors.focus,opacity:"1.0",color:"#FFFFFF"}),t.close.hide(),t.rotate.hide();for(var s in t.resize)t.resize[s].hide()},s.prototype.drag_start=function(e){this.state.drag=!0,this.state.which=e.which,document.onselectstart=function(){return!1}},s.prototype.drag_finish=function(){this.state.drag=!1,this.state.which=null,document.onselectstart=null},s.prototype.register_entry_event_bindings=function(e){var t;t=this,e.bbox.hover(function(){var e;e=$(this).prevAll("."+t.options.classes.bbox).length,t.hover_entry(e)},function(){t.hover_entry(null)}),null!=e.assignment&&e.assignment.hover(function(){var e;e=$(this).prevAll("."+t.options.classes.bbox).length-1,t.hover_entry(e)},function(){t.hover_entry(null)}),e.close.mouseup(function(e){var s;parent=$(this).parent("."+t.options.classes.bbox),s=parent.prevAll("."+t.options.classes.bbox).length,t.state.mode="close",t.delete_entry_interaction(e,s)}),e.rotate.mousedown(function(e){var s,i,o;if(3!=e.which){if(s=$(this).parent("."+t.options.classes.bbox).prevAll("."+t.options.classes.bbox).length,i=t.entries[s],o=t.elements.entries[s],t.state.mode="rotate",t.entries_style_transparent(t.options.colors.transparent,s),null!=i.parent&&(element2=t.elements.entries[i.parent],element2.bbox.css({opacity:1})),!t.options.debug){o.label.hide(),o.close.hide();for(var n in o.resize)o.resize[n].hide()}document.onselectstart=function(){return!1},t.anchor_update(e,null)}});for(var s in e.resize)e.resize[s].mousedown(function(e){1==e.which&&(t.state.mode="resize",t.resize_start($(this),e))})},s}()}).call(this);